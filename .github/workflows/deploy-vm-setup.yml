name: Deploy VM Setup Script

on:
  # Run on push to main branch when setup script changes
  push:
    branches: [ main ]
    paths:
      - 'scripts/setup-vm-and-docker.sh'
      - '.github/workflows/deploy-vm-setup.yml'
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if no changes'
        required: false
        default: false
        type: boolean
      target_environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Verify script format
      run: |
        echo "ðŸ” Checking script format..."
        file scripts/setup-vm-and-docker.sh
        echo "ðŸ“‹ Script first few lines:"
        head -5 scripts/setup-vm-and-docker.sh
        echo "ðŸ“‹ Script last few lines:"
        tail -5 scripts/setup-vm-and-docker.sh
      
    - name: Check if script has changed
      id: check-changes
      run: |
        echo "ðŸ” Checking for changes..."
        echo "Event type: ${{ github.event_name }}"
        echo "Force deploy: ${{ github.event.inputs.force_deploy }}"
        
        if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ github.event.inputs.force_deploy }}" == "true" ]; then
          echo "âœ… Force deployment requested"
          echo "has_changes=true" >> $GITHUB_OUTPUT
        else
          # For push events, always deploy if the script is in the paths filter
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "âœ… Push event detected - deploying"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Unknown event type, assuming changes"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
        fi
        
    - name: Setup SSH
      if: steps.check-changes.outputs.has_changes == 'true'
      run: |
        # Start SSH agent
        eval $(ssh-agent -s)
        
        # Create temporary key file with passphrase handling
        mkdir -p ~/.ssh
        echo "${{ secrets.VM_SSH_PRIVATE_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        # Add key to agent (will prompt for passphrase if needed)
        if [ -n "${{ secrets.VM_SSH_PRIVATE_KEY_PASSPHRASE }}" ]; then
          # Use expect to handle passphrase
          echo '#!/usr/bin/expect' > /tmp/ssh-add.exp
          echo 'spawn ssh-add ~/.ssh/id_rsa' >> /tmp/ssh-add.exp
          echo 'expect "Enter passphrase"' >> /tmp/ssh-add.exp
          echo 'send "${{ secrets.VM_SSH_PRIVATE_KEY_PASSPHRASE }}\r"' >> /tmp/ssh-add.exp
          echo 'expect eof' >> /tmp/ssh-add.exp
          chmod +x /tmp/ssh-add.exp
          /tmp/ssh-add.exp
        else
          ssh-add ~/.ssh/id_rsa
        fi
        
        # Create SSH config to skip host verification
        cat > ~/.ssh/config << EOF
        Host *
          StrictHostKeyChecking no
          UserKnownHostsFile=/dev/null
        EOF
        chmod 600 ~/.ssh/config
        
    - name: Deploy to VM
      if: steps.check-changes.outputs.has_changes == 'true'
      run: |
        # Set target based on input or default to production
        TARGET_ENV="${{ github.event.inputs.target_environment || 'production' }}"
        
        # Get VM IP from secrets (you can add different IPs for different environments)
        if [ "$TARGET_ENV" = "staging" ]; then
          VM_IP="${{ secrets.STAGING_VM_IP }}"
        else
          VM_IP="${{ secrets.PRODUCTION_VM_IP }}"
        fi
        
        echo "ðŸš€ Deploying to $TARGET_ENV environment (IP: $VM_IP)"
        
        # Set username based on environment
        if [ "$TARGET_ENV" = "staging" ]; then
          SSH_USER="${{ secrets.STAGING_SSH_USER || 'admin' }}"
        else
          SSH_USER="${{ secrets.PRODUCTION_SSH_USER || 'admin' }}"
        fi
        
        # Copy script to VM
        echo "ðŸ“¤ Copying script to VM..."
        scp -o StrictHostKeyChecking=no -o ConnectTimeout=30 scripts/setup-vm-and-docker.sh $SSH_USER@$VM_IP:/tmp/
        
        # Test SSH connection
        echo "ðŸ” Testing SSH connection..."
        ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 $SSH_USER@$VM_IP "echo 'SSH connection successful'"
        
        # Execute script on VM
        echo "ðŸš€ Executing setup script on VM..."
        ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 $SSH_USER@$VM_IP << 'EOF'
          set -e  # Exit on any error
          
          echo "ðŸ” Starting VM setup deployment..."
          echo "ðŸ“‹ Current directory: $(pwd)"
          echo "ðŸ“‹ Script location: /tmp/setup-vm-and-docker.sh"
          
          # Check if script exists and is readable
          if [ ! -f /tmp/setup-vm-and-docker.sh ]; then
            echo "âŒ Script not found at /tmp/setup-vm-and-docker.sh"
            exit 1
          fi
          
          # Make script executable
          echo "ðŸ”§ Making script executable..."
          chmod +x /tmp/setup-vm-and-docker.sh
          
          # Verify script is executable
          if [ ! -x /tmp/setup-vm-and-docker.sh ]; then
            echo "âŒ Script is not executable"
            exit 1
          fi
          
          # Create backup of current setup
          echo "ðŸ“‹ Creating backup..."
          sudo cp /tmp/setup-vm-and-docker.sh /tmp/setup-vm-and-docker.sh.backup.$(date +%Y%m%d_%H%M%S)
          
          # Execute the setup script
          echo "âš¡ Executing setup script..."
          sudo bash /tmp/setup-vm-and-docker.sh
          
          echo "âœ… VM setup deployment completed!"
          echo "ðŸš€ Ready for Docker Swarm deployments!"
          echo "ðŸ“‹ Nginx management: /opt/manage-nginx.sh"
        EOF
        
    - name: Skip deployment
      if: steps.check-changes.outputs.has_changes == 'false'
      run: |
        echo "â­ï¸ No changes detected in setup script. Skipping deployment."
        echo "To force deployment, use the manual trigger with 'Force deployment' option."
