name: Deploy VM Setup Script

on:
  # Run on push to main branch when setup script changes
  push:
    branches: [ main ]
    paths:
      - 'scripts/setup-vm-and-docker.sh'
      - '.github/workflows/deploy-vm-setup.yml'
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if no changes'
        required: false
        default: false
        type: boolean
      target_environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Verify script format
      run: |
        echo "üîç Checking script format..."
        file scripts/setup-vm-and-docker.sh
        echo "üìã Script first few lines:"
        head -5 scripts/setup-vm-and-docker.sh
        echo "üìã Script last few lines:"
        tail -5 scripts/setup-vm-and-docker.sh
      
    - name: Check if script has changed
      id: check-changes
      run: |
        echo "üîç Checking for changes..."
        echo "Event type: ${{ github.event_name }}"
        echo "Force deploy: ${{ github.event.inputs.force_deploy }}"
        
        if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ github.event.inputs.force_deploy }}" == "true" ]; then
          echo "‚úÖ Force deployment requested"
          echo "has_changes=true" >> $GITHUB_OUTPUT
        else
          # For push events, always deploy if the script is in the paths filter
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "‚úÖ Push event detected - deploying"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Unknown event type, assuming changes"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
        fi
        
    - name: Setup SSH with passphrase support
      if: steps.check-changes.outputs.has_changes == 'true'
      uses: shimataro/ssh-key-action@v2
      with:
        key: ${{ secrets.VM_SSH_PRIVATE_KEY }}
        known_hosts: ${{ secrets.VM_SSH_KNOWN_HOSTS || '' }}
        passphrase: ${{ secrets.VM_SSH_PRIVATE_KEY_PASSPHRASE || '' }}
        
    - name: Deploy to VM
      if: steps.check-changes.outputs.has_changes == 'true'
      run: |
        # Set target based on input or default to production
        TARGET_ENV="${{ github.event.inputs.target_environment || 'production' }}"
        
        # Get VM IP from secrets (you can add different IPs for different environments)
        if [ "$TARGET_ENV" = "staging" ]; then
          VM_IP="${{ secrets.STAGING_VM_IP }}"
        else
          VM_IP="${{ secrets.PRODUCTION_VM_IP }}"
        fi
        
        echo "üöÄ Deploying to $TARGET_ENV environment (IP: $VM_IP)"
        
        # Set username based on environment
        if [ "$TARGET_ENV" = "staging" ]; then
          SSH_USER="${{ secrets.STAGING_SSH_USER || 'admin' }}"
        else
          SSH_USER="${{ secrets.PRODUCTION_SSH_USER || 'admin' }}"
        fi
        
        # Copy script to VM
        echo "üì§ Copying script to VM..."
        scp -o StrictHostKeyChecking=no -o ConnectTimeout=30 scripts/setup-vm-and-docker.sh $SSH_USER@$VM_IP:/tmp/
        
        # Test SSH connection
        echo "üîç Testing SSH connection..."
        ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 $SSH_USER@$VM_IP "echo 'SSH connection successful'"
        
        # Execute script on VM
        echo "üöÄ Executing setup script on VM..."
        ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 $SSH_USER@$VM_IP << 'EOF'
          set -e  # Exit on any error
          
          echo "üîê Starting VM setup deployment..."
          echo "üìã Current directory: $(pwd)"
          echo "üìã Script location: /tmp/setup-vm-and-docker.sh"
          
          # Check if script exists and is readable
          if [ ! -f /tmp/setup-vm-and-docker.sh ]; then
            echo "‚ùå Script not found at /tmp/setup-vm-and-docker.sh"
            exit 1
          fi
          
          # Make script executable
          echo "üîß Making script executable..."
          chmod +x /tmp/setup-vm-and-docker.sh
          
          # Verify script is executable
          if [ ! -x /tmp/setup-vm-and-docker.sh ]; then
            echo "‚ùå Script is not executable"
            exit 1
          fi
          
          # Create backup of current setup
          echo "üìã Creating backup..."
          sudo cp /tmp/setup-vm-and-docker.sh /tmp/setup-vm-and-docker.sh.backup.$(date +%Y%m%d_%H%M%S)
          
          # Execute the setup script
          echo "‚ö° Executing setup script..."
          sudo bash /tmp/setup-vm-and-docker.sh
          
          echo "‚úÖ VM setup deployment completed!"
          echo "üöÄ Ready for Docker Swarm deployments!"
          echo "üìã Nginx management: /opt/manage-nginx.sh"
        EOF
        
    - name: Skip deployment
      if: steps.check-changes.outputs.has_changes == 'false'
      run: |
        echo "‚è≠Ô∏è No changes detected in setup script. Skipping deployment."
        echo "To force deployment, use the manual trigger with 'Force deployment' option."
