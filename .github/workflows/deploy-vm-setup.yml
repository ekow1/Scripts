name: Deploy VM Setup Script

on:
  # Run on push to main branch when setup script changes
  push:
    branches: [ main ]
    paths:
      - 'scripts/setup-vm-and-docker.sh'
      - '.github/workflows/deploy-vm-setup.yml'
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if no changes'
        required: false
        default: false
        type: boolean
      target_environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check if script has changed
      id: check-changes
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ github.event.inputs.force_deploy }}" == "true" ]; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
        else
          if git diff --name-only ${{ github.event.before }} ${{ github.event.after }} | grep -q "scripts/setup-vm-and-docker.sh"; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
        fi
        
    - name: Setup SSH
      if: steps.check-changes.outputs.has_changes == 'true'
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.VM_SSH_PRIVATE_KEY }}
        
    - name: Deploy to VM
      if: steps.check-changes.outputs.has_changes == 'true'
      run: |
        # Set target based on input or default to production
        TARGET_ENV="${{ github.event.inputs.target_environment || 'production' }}"
        
        # Get VM IP from secrets (you can add different IPs for different environments)
        if [ "$TARGET_ENV" = "staging" ]; then
          VM_IP="${{ secrets.STAGING_VM_IP }}"
        else
          VM_IP="${{ secrets.PRODUCTION_VM_IP }}"
        fi
        
        echo "🚀 Deploying to $TARGET_ENV environment (IP: $VM_IP)"
        
        # Copy script to VM
        scp -o StrictHostKeyChecking=no scripts/setup-vm-and-docker.sh ubuntu@$VM_IP:/tmp/
        
        # Execute script on VM
        ssh -o StrictHostKeyChecking=no ubuntu@$VM_IP << 'EOF'
          echo "🔐 Starting VM setup deployment..."
          
          # Make script executable
          chmod +x /tmp/setup-vm-and-docker.sh
          
          # Create backup of current setup
          echo "📋 Creating backup..."
          sudo cp /tmp/setup-vm-and-docker.sh /tmp/setup-vm-and-docker.sh.backup.$(date +%Y%m%d_%H%M%S)
          
          # Execute the setup script
          echo "⚡ Executing setup script..."
          sudo /tmp/setup-vm-and-docker.sh
          
          echo "✅ VM setup deployment completed!"
          echo "🚀 Ready for Docker Swarm deployments!"
          echo "📋 Nginx management: /opt/manage-nginx.sh"
        EOF
        
    - name: Skip deployment
      if: steps.check-changes.outputs.has_changes == 'false'
      run: |
        echo "⏭️ No changes detected in setup script. Skipping deployment."
        echo "To force deployment, use the manual trigger with 'Force deployment' option."
